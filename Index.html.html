<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ProgettoX: Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
      // Configurazione base per estendere i colori di Tailwind CSS
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                collaboratore: '#10B981', // emerald-500
                sostenitore: '#3B82F6',   // blue-500
                validatore: '#8B5CF6',    // violet-500
              },
            },
          },
        },
      }
    </script>
    <style>
        /* Stile per nascondere le viste di default */
        .view { display: none; }
        /* Stile per mostrare la vista attiva */
        .view.active { display: block; }
        /* Semplice animazione di ingresso per le viste */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view.active { animation: fadeIn 0.3s ease-in-out; }
        /* Stile per l'indicatore di caricamento (loader) */
        #loader {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* Modificato per rispettare i temi Telegram */
            background-color: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.8));
            opacity: 0.8;
            z-index: 100;
        }
        /* Versione scura del loader */
        .dark #loader { background-color: var(--tg-theme-secondary-bg-color, rgba(15, 23, 42, 0.8)); }

        /* Stile per la notifica modale */
        #modal-notification-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #modal-notification-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Stili per il pannello dettagli missione a scomparsa (invariato) */
        .mission-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .mission-details.open {
            max-height: 200px; /* Altezza sufficiente per il contenuto */
            padding-top: 0.75rem; /* pt-3 */
        }

        /* * STILI PER ADATTARSI AI TEMI TELEGRAM 
         * Usiamo le variabili CSS fornite da Telegram
        */
        body {
            background-color: var(--tg-theme-bg-color, #f1f5f9);
            color: var(--tg-theme-text-color, #1e293b);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 1rem; /* Rimosso p-4 precedente per un padding più standard */
        }
        #app-container {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            max-width: 100%; /* Occupa tutta la larghezza del webview */
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        /* Aggiorna gli stili di Tailwind per usare le variabili TG */
        .dark #app-container { background-color: var(--tg-theme-secondary-bg-color, #1e293b); }
        .bg-slate-100 { background-color: var(--tg-theme-bg-color, #f1f5f9); }
        .dark .bg-slate-900 { background-color: var(--tg-theme-bg-color, #0f172a); }
        .text-slate-800 { color: var(--tg-theme-text-color, #1e293b); }
        .dark .text-slate-200 { color: var(--tg-theme-text-color, #e2e8f0); }
        .text-slate-500 { color: var(--tg-theme-hint-color, #64748b); }
        .dark .text-slate-400 { color: var(--tg-theme-hint-color, #94a3b8); }
        .bg-white { background-color: var(--tg-theme-secondary-bg-color, #ffffff); }
        .dark .bg-slate-800\/50 { background-color: var(--tg-theme-secondary-bg-color, #1e293b); opacity: 0.5; }
        .dark .bg-slate-900\/50 { background-color: var(--tg-theme-bg-color, #0f172a); opacity: 0.5; }
        .text-slate-900 { color: var(--tg-theme-text-color, #0f172a); }
        .dark .text-white { color: var(--tg-theme-text-color, #ffffff); }
        .border-slate-200 { border-color: var(--tg-theme-bg-color, #e2e8f0); }
        .dark .border-slate-700 { border-color: var(--tg-theme-bg-color, #334155); }
        .bg-slate-100 { background-color: var(--tg-theme-bg-color, #f1f5f9); }
        .dark .bg-slate-700 { background-color: var(--tg-theme-bg-color, #334155); }
        .dark .bg-slate-700\/50 { background-color: var(--tg-theme-bg-color, #334155); opacity: 0.5; }
        .bg-slate-200 { background-color: var(--tg-theme-button-color, #e2e8f0); }
        .dark .bg-slate-600 { background-color: var(--tg-theme-button-color, #475569); }
        
        /* Colori bottoni principali */
        .bg-indigo-600 { background-color: var(--tg-theme-button-color, #4f46e5); color: var(--tg-theme-button-text-color, #ffffff); }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .text-indigo-600 { color: var(--tg-theme-button-color, #4f46e5); }
        .border-indigo-600 { border-color: var(--tg-theme-button-color, #4f46e5); }
        
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="modal-notification-overlay">
        <div id="modal-notification-box" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg text-center w-11/12 max-w-sm">
            <div id="modal-notification-icon-container" class="flex justify-center mb-4">
                </div>
            <p id="modal-notification-message" class="font-semibold"></p>
        </div>
    </div>
    
    <div id="telegram-error" class="hidden text-center p-10">
        <div class="flex justify-center mb-6">
            <div class="p-3 bg-red-100 dark:bg-red-900/50 rounded-full">
                <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500"></i>
            </div>
        </div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Errore</h1>
        <p class="text-slate-500 dark:text-slate-400 mt-2 mb-8">
            Questa applicazione è una Telegram Mini App.
            <br>
            Per favore, aprila all'interno del client Telegram.
        </p>
    </div>

    <main id="app-container" class="w-full max-w-[520px] rounded-2xl shadow-2xl shadow-indigo-500/10 overflow-hidden relative">

        <div id="loader" class="flex items-center justify-center">
            <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <div class="p-6 sm:p-8">

            <section id="register-choice" class="view">
                <h2 class="text-2xl font-bold mb-2 text-center">Benvenuto in ProgettoX</h2>
                <p class="text-slate-500 dark:text-slate-400 mt-2 mb-8 text-center">
                    Per iniziare, scegli il tuo ruolo. I tuoi dati Telegram saranno usati per creare il tuo profilo.
                </p>
                 <div class="space-y-4">
                    <button data-view="register-form" data-role="Collaboratore" class="w-full border-2 border-emerald-500 text-emerald-500 hover:bg-emerald-500 hover:text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                        <i data-lucide="users" class="w-5 h-5"></i> Collaboratore
                    </button>
                    <button data-view="register-form" data-role="Sostenitore" class="w-full border-2 border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                        <i data-lucide="heart" class="w-5 h-5"></i> Sostenitore
                    </button>
                </div>
            </section>

            <section id="register-form" class="view">
                <h2 class="text-2xl font-bold mb-1">Conferma Registrazione</h2>
                <p class="text-slate-500 mb-6">Stai per unirti a noi come <span id="registration-role-display" class="font-bold"></span>.</p>
                
                <div class="space-y-4">
                    <p class="text-sm text-slate-600 dark:text-slate-400 p-4 bg-slate-100 dark:bg-slate-700/50 rounded-xl">
                        Cliccando "Conferma", il tuo profilo Telegram (<span id="telegram-user-info" class="font-semibold"></span>) sarà collegato al ruolo scelto.
                    </p>
                    <button id="confirm-registration-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105">Conferma e Inizia</button>
                </div>
            </section>

            <section id="profile" class="view">
                 <div id="simulation-notice" class="hidden p-4 border-l-4 border-yellow-400 bg-yellow-50 dark:bg-yellow-900/50 mb-6 rounded-r-lg">
                    <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-300">Stai visualizzando in modalità simulazione.</p>
                 </div>
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div id="user-avatar" class="w-16 h-16 rounded-full bg-indigo-200 dark:bg-indigo-800 flex items-center justify-center text-2xl font-bold text-indigo-600 dark:text-indigo-300"></div>
                        <div>
                            <h3 id="user-name" class="text-xl font-bold"></h3>
                            <p id="user-email" class="text-sm text-slate-500 dark:text-slate-400"></p>
                        </div>
                    </div>
                    <div class="text-center sm:text-right">
                        <span id="user-role-badge" class="px-3 py-1 text-sm font-bold text-white rounded-full"></span>
                        <p id="user-rank" class="text-xs text-slate-400 mt-1"></p>
                        <div class="flex justify-center sm:justify-end gap-4 mt-2">
                            <div class="text-center">
                                <span id="profile-hourglass-count" class="font-bold text-lg text-yellow-500">0</span>
                                <span class="block text-xs text-slate-400">Clessidre</span>
                            </div>
                            <div class="text-center">
                                <span id="profile-donation-count" class="font-bold text-lg text-green-500">0 €</span>
                                <span class="block text-xs text-slate-400">Donati</span>
                            </div>
                        </div>
                        </div>
                </div>
                <hr class="my-6 border-slate-200 dark:border-slate-700">
                <div class="grid grid-cols-2 gap-4">
                    <button data-view="missione-in-corso" class="bg-slate-100 dark:bg-slate-700/50 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 p-4 rounded-xl text-center transition"><i data-lucide="play-circle" class="w-8 h-8 mx-auto text-indigo-500"></i><span class="block mt-2 text-sm font-semibold">In Corso</span></button>
                    <button data-view="pianifica" class="bg-slate-100 dark:bg-slate-700/50 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 p-4 rounded-xl text-center transition"><i data-lucide="map" class="w-8 h-8 mx-auto text-indigo-500"></i><span class="block mt-2 text-sm font-semibold">Pianifica</span></button>
                    <button data-view="storico-obiettivi" class="bg-slate-100 dark:bg-slate-700/50 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 p-4 rounded-xl text-center transition"><i data-lucide="history" class="w-8 h-8 mx-auto text-indigo-500"></i><span class="block mt-2 text-sm font-semibold">Obiettivi</span></button>
                    <button data-view="nft" class="bg-slate-100 dark:bg-slate-700/50 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 p-4 rounded-xl text-center transition"><i data-lucide="gem" class="w-8 h-8 mx-auto text-indigo-500"></i><span class="block mt-2 text-sm font-semibold">NFT Wallet</span></button>
                </div>
                <div class="mt-4">
                     <button id="validatore-valida-btn" data-view="validation-queue" class="hidden w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="qr-code" class="w-5 h-5"></i> Vedi Coda di Validazione
                    </button>
                    <button id="sostenitore-crea-missione-btn" data-view="create-mission-step1" class="hidden w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Crea una nuova Missione
                    </button>
                </div>
                <div class="mt-6 text-center">
                    <button id="logout-btn" class="text-sm text-slate-500 hover:text-red-500">Chiudi App</button>
                    <button id="exit-simulation-btn" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-yellow-900 font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                        <i data-lucide="arrow-left-circle" class="w-5 h-5"></i> Torna a Master Dashboard
                    </button>
                </div>
            </section>

            <section id="pianifica" class="view">
                 <h2 class="text-2xl font-bold mb-4">Pianifica</h2>
                <div class="aspect-video w-full rounded-xl overflow-hidden border-2 border-slate-200 dark:border-slate-700">
                    <iframe id="map-iframe" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d387193.3059499443!2d-74.25986540376716!3d40.69714942296562!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c24fa5d33f083b%3A0xc80b8f06e177fe62!2sNew%20York%2C%20NY%2C%20USA!5e0!3m2!1sen!2sit!4v1635411756485!5m2!1sen!2sit" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                </div>
                <div id="mission-list-container" class="space-y-3 mt-4 max-h-52 overflow-y-auto pr-2">
                    </div>
            </section>

            <section id="missione-in-corso" class="view">
                <h2 class="text-2xl font-bold mb-4">Missione in Corso</h2>

                <div id="active-mission-objectives">
                    </div>
                
                <hr class="my-6 border-slate-200 dark:border-slate-700">
                <h3 class="text-xl font-bold mb-4">Esito Validazioni</h3>
                <div id="validation-results-container" class="space-y-3 max-h-40 overflow-y-auto pr-2">
                    </div>
                <hr class="my-6 border-slate-200 dark:border-slate-700">

                <h3 class="text-xl font-bold mb-4">Progresso Generale</h3>
                <div class="bg-slate-100 dark:bg-slate-700/50 p-6 rounded-xl text-center mb-6">
                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Clessidre Riscattate</p>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <i data-lucide="hourglass" class="w-8 h-8 text-yellow-500"></i>
                        <span id="hourglassCount" class="text-4xl font-bold">0</span>
                    </div>
                </div>
                <div class="mb-6">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">Punti Esperienza</span>
                        <span id="progressText" class="text-sm font-mono font-semibold">0 / 60</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4 overflow-hidden"><div id="progressBar" class="bg-yellow-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                </div>
                <div class="flex gap-2">
                    <button data-progress-points="7" class="flex-1 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-sm font-semibold py-2 px-3 rounded-xl transition">+7 Punti</button>
                    <button data-progress-points="15" class="flex-1 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-sm font-semibold py-2 px-3 rounded-xl transition">+15 Punti</button>
                    <button data-progress-points="-10" class="flex-1 bg-red-200 dark:bg-red-800/50 hover:bg-red-300 dark:hover:bg-red-700/50 text-red-800 dark:text-red-300 text-sm font-semibold py-2 px-3 rounded-xl transition">-10 Punti</button>
                </div>
            </section>
            <section id="nft" class="view">
                <h2 class="text-2xl font-bold mb-4">NFT Wallet</h2>
                <div class="flex flex-col-reverse md:flex-row gap-6 mb-6">
                    <div class="w-full md:w-1/2 flex flex-col justify-center">
                        <h3 id="nft-showcase-name" class="text-2xl font-bold">Seleziona un NFT</h3>
                        <p id="nft-showcase-description" class="text-slate-500 dark:text-slate-400 mt-2">I dettagli appariranno qui.</p>
                        <p id="nft-showcase-id" class="text-sm font-mono text-slate-400 dark:text-slate-500 mt-4"></p>
                    </div>
                    <div class="w-full md:w-1/2"><div id="nft-showcase-image" class="w-full aspect-square bg-slate-200 dark:bg-slate-700 rounded-xl flex items-center justify-center"><i data-lucide="image" class="w-16 h-16 text-slate-400 dark:text-slate-500"></i></div></div>
                </div>
                <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                     <h4 class="font-semibold mb-2">La tua Collezione</h4>
                     <div id="nft-list" class="w-full max-h-40 overflow-y-auto space-y-2 pr-2"></div>
                </div>
            </section>

            <section id="donate" class="view">
                 <h2 class="text-2xl font-bold mb-4">Supporta il Progetto</h2>

                <form id="donationForm" class="space-y-4 mb-6">
                    <label for="donation-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Importo Donazione (€)</label>
                    <input type="number" id="donation-amount" placeholder="Es. 50" min="1" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl border-2 border-transparent focus:border-indigo-500 focus:outline-none" required>
                    <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-yellow-900 font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105 flex items-center justify-center gap-2">
                        <i data-lucide="gift" class="w-5 h-5"></i> Dona Ora
                    </button>
                </form>

                <div class="bg-slate-100 dark:bg-slate-700/50 p-6 rounded-xl text-center mb-6">
                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Totale Donazioni Ricevute</p>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <i data-lucide="coins" class="w-8 h-8 text-yellow-500"></i>
                        <span id="donatedCredit" class="text-4xl font-bold">1234 €</span>
                    </div>
                </div>
                 <button data-view="donations-list" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition-transform transform hover:scale-105 flex items-center justify-center gap-2"><i data-lucide="search" class="w-5 h-5"></i> Esplora le donazioni materiali</button>
            </section>

            <section id="donations-list" class="view">
                <h2 class="text-2xl font-bold mb-4">Elenco Donazioni Materiali</h2>
                <div id="donations-list-container" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"></div>
            </section>

            <section id="master-dashboard" class="view">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold">Dashboard Master</h2>
                        <p class="text-sm text-slate-500">Pannello di controllo e monitoraggio</p>
                    </div>
                    <button id="master-logout-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-xl transition">Chiudi</button>
                </div>

                <div class="space-y-6">
                    <div class="space-y-2">
                        <h3 class="font-semibold mb-2">Impostazioni</h3>
                        <div class="p-3 bg-slate-100 dark:bg-slate-900/50 rounded-xl">
                            <label for="donation-threshold" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Soglia donazione per Sostenitori (per creare missioni)</label>
                            <input type="number" id="donation-threshold" value="500" class="w-full mt-2 p-2 bg-slate-200 dark:bg-slate-700 rounded-lg border-2 border-transparent focus:border-indigo-500 focus:outline-none">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <h3 class="font-semibold mb-2">Gestione Missioni</h3>
                        <button data-view="create-mission-step1" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> CREA MISSIONE
                        </button>
                        <button data-view="manage-missions" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                            <i data-lucide="list-checks" class="w-5 h-5"></i> GESTISCI MISSIONI
                        </button>
                        <button data-view="manage-common-objectives" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                            <i data-lucide="award" class="w-5 h-5"></i> GESTISCI OBIETTIVI COMUNI
                        </button>
                    </div>

                    <div>
                        <h3 class="font-semibold mb-2">Simula Vista Utente</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <button data-simulate-role="Collaboratore" class="p-3 border-2 border-emerald-500 text-emerald-500 hover:bg-emerald-500 hover:text-white rounded-xl transition text-sm">Collaboratore</button>
                            <button data-simulate-role="Sostenitore" class="p-3 border-2 border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white rounded-xl transition text-sm">Sostenitore</button>
                            <button data-simulate-role="Validatore" class="p-3 border-2 border-violet-500 text-violet-500 hover:bg-violet-500 hover:text-white rounded-xl transition text-sm">Validatore</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold mb-2">Log Attività (Simulato)</h3>
                        <div id="activity-log-container" class="space-y-3 max-h-[250px] overflow-y-auto pr-2 bg-slate-100 dark:bg-slate-900/50 p-4 rounded-xl"></div>
                    </div>
                </div>
            </section>

            <section id="create-mission-step1" class="view">
                 <h2 id="mission-form-title-step1" class="text-2xl font-bold mb-4">Crea Missione (Step 1/2)</h2>
                <form id="createMissionFormStep1" class="space-y-4">
                    <input type="text" id="mission-name" placeholder="Nome Missione (es. Area Gamma)" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl" required>
                    <textarea id="mission-description" placeholder="Descrizione della missione..." rows="3" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl" required></textarea>

                    <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 pt-2">Posizione</p>
                    <div class="grid grid-cols-2 gap-4">
                         <input type="number" step="any" id="mission-lat" placeholder="Latitudine" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                         <input type="number" step="any" id="mission-lon" placeholder="Longitudine" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                    </div>
                    <div class="text-center text-sm text-slate-400 my-2">oppure</div>
                    <input type="text" id="mission-street" placeholder="Via e Numero Civico" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="mission-city" placeholder="Città" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                        <input type="text" id="mission-country" placeholder="Nazione" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                    </div>

                    <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 pt-2">Stile</p>
                    <select id="mission-color" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl appearance-none">
                        <option value="indigo">Blu (Standard)</option>
                        <option value="violet">Viola</option>
                        <option value="teal">Verde Acqua</option>
                        <option value="amber">Ambra</option>
                    </select>

                    <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 pt-2">Partecipanti</p>
                    <input type="number" id="mission-max-users" placeholder="Numero max. partecipanti" class="w-full p-3 bg-slate-100 dark:bg-slate-700 rounded-xl" required min="1" value="1">
                    <p id="mission-step1-error" class="text-red-500 text-sm hidden"></p>
                    <button id="mission-step1-submit-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition">Avanti: Aggiungi Obiettivi</button>
                </form>
            </section>
            <section id="create-mission-step2" class="view">
                <h2 id="mission-form-title-step2" class="text-2xl font-bold mb-1">Aggiungi Obiettivi (Step 2/2)</h2>
                <p class="text-slate-500 mb-4">per la missione: <span id="new-mission-title" class="font-bold"></span></p>

                <div id="new-mission-objectives-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto pr-2">
                    </div>

                <form id="addObjectiveForm" class="flex gap-2">
                    <input type="text" id="objective-text" placeholder="Testo del nuovo obiettivo..." class="flex-grow p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                    <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-xl transition"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </form>

                <hr class="my-6 border-slate-200 dark:border-slate-700">
                <button id="save-mission-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-xl transition">Salva Missione e Obiettivi</button>
            </section>

            <section id="missione-accettata" class="view">
                 <h2 id="accepted-mission-title" class="text-2xl font-bold mb-4"></h2>

                <div id="mission-timer-container" class="hidden my-4 p-4 bg-amber-50 dark:bg-amber-900/50 border-l-4 border-amber-400 rounded-r-lg">
                    <p class="text-sm font-semibold text-amber-800 dark:text-amber-300">Periodo di commitment</p>
                    <p class="text-xs text-amber-600 dark:text-amber-400">Non interrompere la missione per 60 minuti per ricevere una ricompensa bonus.</p>
                    <div class="flex justify-between items-center mt-3">
                        <span id="mission-timer" class="font-mono text-lg font-bold">--:--</span>
                        <button id="interrupt-mission-btn" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2 px-3 rounded-lg transition">INTERROMPI</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <h3 class="font-semibold text-slate-500 dark:text-slate-400">Descrizione</h3>
                        <p id="accepted-mission-description" class="p-4 bg-slate-100 dark:bg-slate-700/50 rounded-xl"></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-500 dark:text-slate-400">Posizione</h3>
                        <p id="accepted-mission-location" class="p-4 bg-slate-100 dark:bg-slate-700/50 rounded-xl"></p>
                    </div>
                    <div class="pt-2">
                        <button data-view="missione-in-corso" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                            <i data-lucide="target" class="w-5 h-5"></i> Vai agli Obiettivi
                        </button>
                    </div>
                </div>
            </section>

            <section id="manage-missions" class="view">
                <h2 class="text-2xl font-bold mb-4">Gestisci Missioni</h2>
                <div id="manage-missions-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    </div>
            </section>

             <section id="storico-obiettivi" class="view">
                <h2 class="text-2xl font-bold mb-4">Obiettivi Comuni</h2>
                <div id="common-objectives-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2">
                    </div>

                <hr class="my-6 border-slate-200 dark:border-slate-700">

                <h2 class="text-2xl font-bold mb-4">Storico Missioni</h2>
                <div id="completed-missions-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                    </div>
            </section>

            <section id="manage-common-objectives" class="view">
                <h2 class="text-2xl font-bold mb-4">Gestisci Obiettivi Comuni</h2>

                <div id="manage-common-objectives-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto pr-2">
                    </div>

                <form id="addCommonObjectiveForm" class="flex gap-2">
                    <input type="text" id="common-objective-text" placeholder="Testo del nuovo obiettivo..." class="flex-grow p-3 bg-slate-100 dark:bg-slate-700 rounded-xl" required>
                    <input type="number" id="common-objective-target" placeholder="Target" class="w-24 p-3 bg-slate-100 dark:bg-slate-700 rounded-xl" required min="1">
                    <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-xl transition"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </form>
            </section>

            <section id="validation-queue" class="view">
                <h2 class="text-2xl font-bold mb-4">Coda di Validazione</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Approva o rifiuta le richieste di validazione inviate dai Collaboratori.</p>
                <div id="validation-queue-container" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    </div>
            </section>

        </div>

        <button data-view="donate" class="absolute bottom-5 right-5 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
            <i data-lucide="gift" class="w-6 h-6"></i>
        </button>

    </main>

    <script type="module">
        // ===================================================================================
        // 1. CONFIGURAZIONE E INIZIALIZZAZIONE GLOBALE
        // ===================================================================================

        // INIZIALIZZAZIONE TELEGRAM WEB APP
        const tg = window.Telegram.WebApp;

        // IMPOSTA QUI IL TUO ID TELEGRAM PER L'ACCESSO MASTER
        // Puoi ottenerlo da bot come @userinfobot
        const MASTER_ADMIN_ID = 123456789; 

        // RIMOZIONE DI TUTTE LE CONFIGURAZIONI FIREBASE
        
        const loader = document.getElementById('loader');
        let missionTimerInterval = null;
        let viewHistory = []; // Per la gestione del BackButton nativo

        // ===================================================================================
        // 2. GESTIONE DELLO STATO DELL'APPLICAZIONE (STATE MANAGEMENT)
        // ===================================================================================
        const state = {
            currentUserProfile: null, // Profilo dell'utente loggato (da TG)
            registrationRole: '',
            // loginRole rimosso, non più necessario
            currentScore: 0, // Punteggio XP dell'utente/simulazione corrente
            hourglasses: 0, // Clessidre dell'utente/simulazione corrente
            isSimulating: false, // Flag per indicare se siamo in modalità simulazione
            newMissionBuffer: null,
            editingMissionBuffer: null,
            activeMission: null, // Missione attiva per l'utente/simulazione corrente

            // --- STATI PER SIMULAZIONE INDIPENDENTE ---
            currentSimulatedRole: null, // Ruolo attualmente simulato (es. 'Collaboratore')
            masterStateCache: null, // Cache dello stato del Master prima della simulazione
            simulatedProfileStates: { // Stati persistenti per ciascun ruolo simulato
                Collaboratore: { activeMission: null, currentScore: 0, hourglasses: 0, totalDonations: 0 },
                Sostenitore:   { activeMission: null, currentScore: 0, hourglasses: 0, totalDonations: 0 },
                Validatore:    { activeMission: null, currentScore: 0, hourglasses: 0, totalDonations: 0 }
            }
        };

        // ===================================================================================
        // MOCK_DATA (INVARIATO)
        // ===================================================================================
        const MOCK_DATA = {
            nfts: [
                { id: 1, name: 'Gemma della Visione', description: 'Conferisce chiarezza e intuizione.', tokenId: '0x1A...B2C', color: 'bg-blue-300' },
                { id: 2, name: 'Seme della Crescita', description: 'Simbolo di potenziale e sviluppo.', tokenId: '0x2D...E3F', color: 'bg-emerald-300' },
            ],
            donations: [ // Donazioni materiali (lista esempio)
                { name: 'Kit di Attrezzi', quantity: 10, description: 'Set completi per la manutenzione.', icon: 'wrench' },
                { name: 'Elmetti di Sicurezza', quantity: 50, description: 'Protezione per i volontari.', icon: 'hard-hat' },
            ],
            missions: [ // Missioni disponibili
                {
                    name: 'Area Alpha', color: 'indigo', description: 'Esplorazione in Area Alpha.', lat: 40.7128, lon: -74.0060, street: 'Liberty Island', city: 'New York', country: 'USA', status: 'available',
                    maxUsers: 1,
                    participants: [],
                    objectives: [
                        { id: 1, text: 'Fotografa 5 punti', progress: 0, target: 5, points: 10 },
                        { id: 2, text: 'Raccogli 3 campioni', progress: 0, target: 3, points: 15 }
                    ]
                },
                {
                    name: 'Area Beta', color: 'violet', description: 'Recupero in Area Beta.', lat: 40.7580, lon: -73.9855, street: 'Times Square', city: 'New York', country: 'USA', status: 'available',
                    maxUsers: 5,
                    participants: ['Utente Prova 1'], // Già un utente dentro
                    objectives: [ { id: 3, text: 'Intervista 2 passanti', progress: 0, target: 2, points: 5 } ]
                }
            ],
            completedMissions: [ // Storico missioni (esempio)
                { name: 'Ricognizione Area Verde', result: 'Successo', pointsEarned: 125 },
                { name: 'Manutenzione Sentiero', result: 'Completata', pointsEarned: 80 }
            ],
            activityLog: [ // Log attività (esempio)
                { user: 'Mario Rossi', action: 'si è registrato.', time: '2 min fa', icon: 'user-plus', color: 'text-emerald-500' },
                { user: 'Laura Bianchi', action: 'ha effettuato l-accesso.', time: '5 min fa', icon: 'log-in', color: 'text-blue-500' },
            ],
            commonObjectives: [ // Obiettivi comuni (esempio)
                { id: 101, text: 'Completa 3 missioni', progress: 1, target: 3 },
                { id: 102, text: 'Guadagna 5 Clessidre', progress: 0, target: 5 },
                { id: 103, text: 'Effettua una donazione', progress: 0, target: 1 }
            ],
            validationQueue: [ // Coda di validazione (esempio)
                { id: 201, missionName: 'Area Alpha', objectiveText: 'Fotografa 5 punti', user: 'Utente Collaboratore' } // Nota: user corrisponde al mock
            ],
            validationResults: [
                // Esempio: { id: 123, user: 'Utente Collaboratore', objectiveText: 'Test', status: 'approved', points: 5 }
            ],
            globalDonationTotal: 1234, // Totale donazioni globali (esempio)
        };
        // ===================================================================================
        // FINE MOCK_DATA
        // ===================================================================================


        // ===================================================================================
        // 3. FUNZIONI DI MANIPOLAZIONE DELL'INTERFACCIA UTENTE (UI)
        // ===================================================================================

        // Mostra/Nasconde l'indicatore di caricamento
        const toggleLoader = (show) => {
            loader.style.display = show ? 'flex' : 'none';
        };

        // ===================================================================================
        // NUOVA FUNZIONE: Gestione Tema Telegram
        // ===================================================================================
        function applyTheme() {
            if (tg.colorScheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            // Aggiorna anche il colore di sfondo principale
            document.body.style.backgroundColor = 'var(--tg-theme-bg-color, #f1f5f9)';
        }

        // ===================================================================================
        // MODIFICATO: showView (con gestione BackButton)
        // ===================================================================================
        
        // Mostra una specifica vista (sezione HTML)
        function showView(viewId, isBack = false) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');

                // Gestione Cronologia per BackButton
                if (!isBack) {
                    if (viewId === 'profile' || viewId === 'register-choice' || viewId === 'master-dashboard') {
                        // Viste "principali", resettano la cronologia
                        viewHistory = [viewId];
                    } else {
                        viewHistory.push(viewId);
                    }
                }
                
                // Mostra/Nascondi BackButton nativo
                if (viewHistory.length > 1) {
                    tg.BackButton.show();
                } else {
                    tg.BackButton.hide();
                }

                // Adatta il pulsante "Indietro" nella vista crea-missione (logica invariata)
                if (viewId === 'create-mission-step1') {
                    // Questa vista ha un pulsante indietro manuale RIMOVsSO, ma la logica 
                    // per impostare la vista di ritorno (profile vs master-dashboard) è ancora
                    // utile per il BackButton nativo.
                    // La logica del BackButton nativo gestirà il ritorno a `viewHistory[viewHistory.length - 2]`
                }
                
                // Popola i dati dinamici della vista #register-form
                if (viewId === 'register-form') {
                    const user = tg.initDataUnsafe.user;
                    const userName = `${user.first_name} ${user.last_name || ''}`.trim();
                    const userHandle = user.username ? `@${user.username}` : userName;
                    document.getElementById('registration-role-display').textContent = state.registrationRole;
                    document.getElementById('telegram-user-info').textContent = userHandle;
                }

                // Chiama le funzioni di rendering specifiche per le viste dinamiche (invariato)
                if (viewId === 'pianifica') renderMissionList(); 
                if (viewId === 'missione-in-corso') {
                    renderActiveMissionObjectives();
                    renderValidationResults(); 
                }
                if (viewId === 'manage-missions') renderManageMissionsList();
                if (viewId === 'storico-obiettivi') { renderCompletedMissions(); renderCommonObjectives(); }
                if (viewId === 'manage-common-objectives') renderManageCommonObjectives();
                if (viewId === 'missione-accettata') startMissionTimer();
                if (viewId === 'validation-queue') renderValidationQueue();

                lucide.createIcons(); // Aggiorna le icone
            }
        }

        // Mostra una notifica modale temporanea (invariato)
        function showNotification(message, type = 'success') {
            const overlay = document.getElementById('modal-notification-overlay');
            const messageEl = document.getElementById('modal-notification-message');
            const iconContainer = document.getElementById('modal-notification-icon-container');

            if (!overlay || !messageEl || !iconContainer) return;

            const icons = { success: 'check', info: 'info', error: 'alert-circle' };
            const colors = { success: 'green', info: 'blue', error: 'red' };
            const icon = icons[type] || 'info';
            const color = colors[type] || 'blue';

            iconContainer.innerHTML = `<div class="w-12 h-12 bg-${color}-100 dark:bg-${color}-900/50 rounded-full flex items-center justify-center">
                <i data-lucide="${icon}" class="w-8 h-8 text-${color}-500"></i></div>`;

            messageEl.textContent = message;
            overlay.classList.add('show');
            lucide.createIcons();

            setTimeout(() => overlay.classList.remove('show'), 3000);
        }

        // Aggiorna la vista del profilo utente con i dati correnti (invariato)
        function updateProfileView(profileData = null) {
            // Usa il profilo passato o quello nello stato (importante per simulazione)
            const profile = profileData || state.currentUserProfile;
            if (!profile) return;
            if (profile.totalDonations === undefined) profile.totalDonations = 0;
            document.getElementById('user-avatar').textContent = profile.name.charAt(0).toUpperCase();
            document.getElementById('user-name').textContent = profile.name;
            document.getElementById('user-email').textContent = profile.email;
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.textContent = profile.role;
            const roleColors = {'Collaboratore': 'bg-brand-collaboratore', 'Sostenitore': 'bg-brand-sostenitore', 'Validatore': 'bg-brand-validatore'};
            roleBadge.className = `px-3 py-1 text-sm font-bold text-white rounded-full ${roleColors[profile.role] || 'bg-slate-500'}`;
            document.getElementById('user-rank').textContent = `Master ${profile.role}`;
            const creaMissioneBtn = document.getElementById('sostenitore-crea-missione-btn');
            const validaBtn = document.getElementById('validatore-valida-btn');
            if (!state.isSimulating) { // Utente Reale
                const threshold = parseInt(document.getElementById('donation-threshold').value) || 500;
                creaMissioneBtn.classList.toggle('hidden', !(profile.role === 'Sostenitore' && profile.totalDonations >= threshold));
                validaBtn.classList.toggle('hidden', profile.role !== 'Validatore');
            } else { // Utente Simulato
                 const threshold = parseInt(document.getElementById('donation-threshold').value) || 500;
                 const simDonations = state.simulatedProfileStates[profile.role]?.totalDonations || 0;
                 creaMissioneBtn.classList.toggle('hidden', !(profile.role === 'Sostenitore' && simDonations >= threshold));
                 validaBtn.classList.toggle('hidden', profile.role !== 'Validatore');
            }
            document.getElementById('profile-hourglass-count').textContent = state.hourglasses;
            const userDonations = (profile.totalDonations || 0).toLocaleString('it-IT') + ' €';
            document.getElementById('profile-donation-count').textContent = userDonations;
        }

        // Mostra un messaggio di errore in un form specifico (invariato)
        function showFormError(formType, message) {
            const errorEl = document.getElementById(`${formType}-error`);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
        }

        // ===================================================================================
        // 4. LOGICA DI BUSINESS (Funzionalità principali dell'app)
        //    (Tutta questa sezione è rimasta INVARIATA)
        // ===================================================================================

        // Aggiorna la barra di progresso XP
        function updateProgressBar() {
            const score = state.currentScore;
            const maxScore = 60;
            const percentage = Math.min((score / maxScore) * 100, 100);
            const bar = document.getElementById('progressBar');
            document.getElementById('progressText').textContent = `${score} / ${maxScore}`;
            bar.style.width = `${percentage}%`;
            bar.classList.toggle('bg-green-500', score >= maxScore);
            bar.classList.toggle('bg-yellow-400', score < maxScore);
        }

        // Aggiunge/rimuove punti XP e aggiorna le clessidre
        function updateProgress(points) {
            state.currentScore += points;
            if (state.currentScore < 0) state.currentScore = 0;

            if (state.currentScore >= 60) {
                state.hourglasses += Math.floor(state.currentScore / 60);
                state.currentScore %= 60;
                document.getElementById('hourglassCount').textContent = state.hourglasses;
                // Aggiorna anche il contatore nel profilo se visibile
                if (document.getElementById('profile').classList.contains('active')) {
                    document.getElementById('profile-hourglass-count').textContent = state.hourglasses;
                }
            }
            updateProgressBar();
        }

        // Ferma il timer della missione (se attivo)
        function stopMissionTimer() {
            if (missionTimerInterval) {
                clearInterval(missionTimerInterval);
                missionTimerInterval = null;
            }
        }

        // Avvia il timer di "commitment" della missione
        function startMissionTimer() {
            stopMissionTimer();
            const timerContainer = document.getElementById('mission-timer-container');
            const timerDisplay = document.getElementById('mission-timer');

            if (!state.activeMission || state.activeMission.initialRewardClaimed) {
                timerContainer.classList.add('hidden');
                return;
            }
            timerContainer.classList.remove('hidden');

            const commitmentDuration = 60 * 60 * 1000; // 60 minuti
            missionTimerInterval = setInterval(() => {
                const elapsed = Date.now() - state.activeMission.missionStartTime;
                const remaining = commitmentDuration - elapsed;

                if (remaining <= 0) {
                    stopMissionTimer();
                    timerContainer.classList.add('hidden');
                    if (!state.activeMission.initialRewardClaimed) {
                        const totalPoints = state.activeMission.objectives.reduce((sum, obj) => sum + obj.points, 0);
                        const reward = Math.ceil(totalPoints * 0.10); // Bonus 10%
                        updateProgress(reward);
                        state.activeMission.initialRewardClaimed = true;
                        showNotification(`Bonus Commitment! Hai ricevuto ${reward} punti.`);
                    }
                } else {
                    const minutes = Math.floor((remaining / 1000 / 60) % 60);
                    const seconds = Math.floor((remaining / 1000) % 60);
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Funzione generica per renderizzare liste (usata per NFT e Donazioni Materiali)
        function renderList(containerId, items, renderFn, noItemsMessage = "Nessun elemento.") {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = items.map(renderFn).join('') || `<p class="text-slate-500 dark:text-slate-400 p-4 text-center">${noItemsMessage}</p>`;

            if (containerId === 'nft-list') {
                container.querySelectorAll('[data-nft-id]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const nftId = parseInt(e.currentTarget.dataset.nftId);
                        const nft = MOCK_DATA.nfts.find(n => n.id === nftId);
                        if(nft) {
                            document.getElementById('nft-showcase-name').textContent = nft.name;
                            document.getElementById('nft-showcase-description').textContent = nft.description;
                            document.getElementById('nft-showcase-id').textContent = `Token ID: ${nft.tokenId}`;
                            document.getElementById('nft-showcase-image').innerHTML = `<div class="w-full h-full ${nft.color} rounded-xl flex items-center justify-center"><i data-lucide="gem" class="w-10 h-10 text-white opacity-50"></i></div>`;
                            lucide.createIcons();
                        }
                    });
                });
            }
             lucide.createIcons();
        }

        // Renderizza il log attività nel Master Dashboard
        function renderActivityLog() {
            renderList('activity-log-container', MOCK_DATA.activityLog, log => `
                <div class="flex items-start gap-3 text-sm">
                    <i data-lucide="${log.icon}" class="w-4 h-4 mt-1 ${log.color} flex-shrink-0"></i>
                    <div>
                        <p class="text-slate-800 dark:text-slate-200"><span class="font-semibold">${log.user}</span> ${log.action}</p>
                        <p class="text-xs text-slate-400">${log.time}</p>
                    </div>
                </div>`);
        }
        
        // Renderizza la lista delle missioni disponibili nella vista "Pianifica"
        function renderMissionList() {
             renderList('mission-list-container', MOCK_DATA.missions, mission => {
                const locationString = [mission.street, mission.city, mission.country].filter(Boolean).join(', ') || `Lat: ${mission.lat?.toFixed(4)}, Lon: ${mission.lon?.toFixed(4)}`;
                let actionButtonHTML = '';
                
                if (state.activeMission && state.activeMission.name === mission.name) {
                     actionButtonHTML = `<button data-view="missione-accettata" data-mission-name="${mission.name}" class="flex-shrink-0 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-3 rounded-lg transition text-xs flex items-center gap-1"><i data-lucide="check-circle" class="w-4 h-4"></i> VAI</button>`;
                } 
                else if (!state.activeMission) {
                    const isFull = mission.participants.length >= mission.maxUsers;
                    if (isFull) {
                        actionButtonHTML = `<span class="flex-shrink-0 bg-slate-400 text-white font-bold py-2 px-3 rounded-lg text-xs flex items-center gap-1"><i data-lucide="lock" class="w-4 h-4"></i> PIENA</span>`;
                    } else {
                        actionButtonHTML = `<button data-mission-name="${mission.name}" class="accept-mission-btn flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition text-xs">ACCETTA</button>`;
                    }
                }
                const participantPanelId = `participants-${mission.name.replace(/\s+/g, '-')}`;
                const participantListHTML = mission.participants.length > 0 
                    ? mission.participants.map(pName => `<p class="text-sm ml-2">- ${pName}</p>`).join('')
                    : '<p class="text-sm text-slate-500 ml-2">Nessun partecipante.</p>';

                return `
                <div class="p-3 bg-slate-100 dark:bg-slate-700/50 rounded-xl">
                    <div class="flex justify-between items-center gap-2">
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200">${mission.name}</h4>
                            <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${locationString}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-mission-name="${mission.name}" class="toggle-participants-btn flex-shrink-0 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 p-2 rounded-lg transition"><i data-lucide="users" class="w-4 h-4"></i></button>
                            <button data-mission-name="${mission.name}" class="toggle-details-btn flex-shrink-0 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 p-2 rounded-lg transition"><i data-lucide="info" class="w-4 h-4"></i></button>
                            <button data-mission-name="${mission.name}" class="view-on-map-btn flex-shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg transition"><i data-lucide="eye" class="w-4 h-4"></i></button>
                            ${actionButtonHTML}
                        </div>
                    </div>
                    <div id="details-${mission.name.replace(/\s+/g, '-')}" class="mission-details border-t border-slate-200 dark:border-slate-600 mt-2 pt-2">
                        <p class="text-sm"><strong>Descrizione:</strong> ${mission.description}</p>
                    </div>
                    <div id="${participantPanelId}" class="mission-details border-t border-slate-200 dark:border-slate-600 mt-2 pt-2">
                        <p class="text-sm"><strong>Partecipanti:</strong> ${mission.participants.length} / ${mission.maxUsers}</p>
                        ${participantListHTML}
                    </div>
                </div>`;
            });
        }

        // Renderizza la lista delle missioni nel Master Dashboard (per modifica)
        function renderManageMissionsList() {
            renderList('manage-missions-list', MOCK_DATA.missions, mission => `
                <div class="p-3 bg-slate-100 dark:bg-slate-700/50 rounded-xl flex justify-between items-center gap-2">
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-slate-200">${mission.name}</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${mission.objectives.length} obiettivi (${mission.participants.length}/${mission.maxUsers} utenti)</p>
                    </div>
                    <button data-mission-name="${mission.name}" class="edit-mission-btn flex-shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center gap-2">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> Modifica
                    </button>
                </div>`);
        }

        // Renderizza lo storico delle missioni completate
        function renderCompletedMissions() {
            renderList('completed-missions-list', MOCK_DATA.completedMissions, mission => `
                <div class="p-3 bg-slate-100 dark:bg-slate-700/50 rounded-xl">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200">${mission.name}</h4>
                            <p class="text-xs text-emerald-500 font-semibold">${mission.result}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-amber-500">+${mission.pointsEarned}</p>
                            <p class="text-xs text-slate-400">Punti</p>
                        </div>
                    </div>
                </div>`);
        }

        // Renderizza gli obiettivi comuni per l'utente
        function renderCommonObjectives() {
            renderList('common-objectives-list', MOCK_DATA.commonObjectives, obj => {
                const percentage = Math.min((obj.progress / obj.target) * 100, 100);
                const isCompleted = obj.progress >= obj.target;
                return `
                    <div class="p-3 bg-slate-100 dark:bg-slate-700/50 rounded-xl">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium">${obj.text}</span>
                            <span class="text-sm font-mono font-semibold">${obj.progress} / ${obj.target}</span>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-3 overflow-hidden">
                            <div class="h-3 rounded-full transition-all duration-500 ${isCompleted ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${percentage}%"></div>
                        </div>
                        ${!isCompleted ? `<div class="text-right mt-2"><button data-common-objective-id="${obj.id}" class="advance-common-objective-btn bg-slate-200 dark:bg-slate-600 text-xs font-bold py-1 px-2 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition">+1 Progresso</button></div>` : ''}
                    </div>`;
            });
        }

        // Renderizza gli obiettivi comuni per il Master (gestione)
        function renderManageCommonObjectives() {
            renderList('manage-common-objectives-list', MOCK_DATA.commonObjectives, obj => `
                <div class="p-2 bg-slate-100 dark:bg-slate-700/50 rounded-lg flex justify-between items-center text-sm">
                    <span>${obj.text} (Target: ${obj.target})</span>
                    <button type="button" data-common-objective-id="${obj.id}" class="remove-common-objective-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`);
        }

        // Aggiorna l'iframe della mappa con la posizione della missione
        function updateMapLocation(mission) {
            const iframe = document.getElementById('map-iframe');
            if (!iframe) return;
            let query = '';
            if (mission.lat && mission.lon) query = `${mission.lat},${mission.lon}`;
            else query = [mission.street, mission.city, mission.country].filter(Boolean).join(', ');

            if (query) {
                iframe.src = `https://maps.google.com/maps?q=$${encodeURIComponent(query)}&hl=it&z=15&output=embed`;
                iframe.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Popola la vista "missione accettata" con i dettagli
        function populateAcceptedMissionView(mission) {
            document.getElementById('accepted-mission-title').textContent = mission.name;
            document.getElementById('accepted-mission-description').textContent = mission.description;
            const locationString = [mission.street, mission.city, mission.country].filter(Boolean).join(', ') || `Coordinate: ${mission.lat?.toFixed(4)}, ${mission.lon?.toFixed(4)}`;
            document.getElementById('accepted-mission-location').textContent = locationString;
        }

        // Renderizza gli obiettivi della missione attiva
        function renderActiveMissionObjectives() {
            const container = document.getElementById('active-mission-objectives');
            if (!container) return;

            if (state.activeMission) {
                container.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Obiettivi di: <span class="text-indigo-500">${state.activeMission.name}</span></h3>
                    <div id="mission-objectives-container" class="space-y-4">
                        ${state.activeMission.objectives.map((obj, index) => {
                            const percentage = Math.min((obj.progress / obj.target) * 100, 100);
                            const isCompleted = obj.progress >= obj.target;
                            const existingRequest = MOCK_DATA.validationQueue.find(req => req.missionName === state.activeMission.name && req.objectiveText === obj.text && req.user === state.currentUserProfile?.name);
                            const buttonDisabled = existingRequest ? 'disabled' : '';
                            const buttonText = existingRequest ? 'In attesa...' : 'Richiedi Validazione';
                            const buttonColor = existingRequest ? 'bg-slate-400' : 'bg-blue-500 hover:bg-blue-600';

                            return `
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium">${obj.text}</span>
                                        <span class="text-sm font-mono font-semibold">${obj.progress} / ${obj.target}</span>
                                    </div>
                                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-3 overflow-hidden">
                                        <div class="h-3 rounded-full transition-all duration-500 ${isCompleted ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${percentage}%"></div>
                                    </div>
                                    ${!isCompleted ? `
                                    <div class="text-right mt-2">
                                        <button data-objective-index="${index}" data-objective-text="${obj.text}" class="request-validation-btn ${buttonColor} text-white text-xs font-bold py-1 px-2 rounded-md transition" ${buttonDisabled}><i data-lucide="qr-code" class="w-3 h-3 inline-block mr-1"></i> ${buttonText}</button>
                                    </div>` : ''}
                                </div>`;
                        }).join('')}
                    </div>`;
            } else {
                container.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Obiettivi Missione</h3>
                    <p class="text-slate-500 dark:text-slate-400">Nessuna missione attiva. Accettane una dalla pagina "Pianifica".</p>`;
            }
            lucide.createIcons();
        }
        
        // Renderizza i risultati della validazione
        function renderValidationResults() {
            if (!state.currentUserProfile) return; 
            const userResults = MOCK_DATA.validationResults.filter(r => r.user === state.currentUserProfile.name);
            renderList('validation-results-container', userResults, result => {
                const isApproved = result.status === 'approved';
                const colorClass = isApproved ? 'text-green-500' : 'text-red-500';
                const text = isApproved ? `Approvato (+${result.points.toFixed(0)} punti)` : 'Rifiutato';
                return `
                <div class="p-3 bg-slate-100 dark:bg-slate-700/50 rounded-xl flex justify-between items-center text-sm">
                    <div>
                        <p class="font-medium text-slate-800 dark:text-slate-200">${result.objectiveText}</p>
                        <p class="${colorClass} font-semibold text-xs">${text}</p>
                    </div>
                    <button data-result-id="${result.id}" class="dismiss-result-btn text-slate-400 hover:text-red-500 p-1 transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                `;
            }, "Nessun esito di validazione recente.");
        }
        
        // Renderizza la coda di validazione per il Validatore
        function renderValidationQueue() {
            renderList('validation-queue-container', MOCK_DATA.validationQueue, item => `
                <div class="p-4 bg-slate-100 dark:bg-slate-700/50 rounded-xl">
                    <p class="font-bold text-slate-800 dark:text-slate-200">${item.objectiveText}</p>
                    <p class="text-sm text-slate-600 dark:text-slate-400">Missione: ${item.missionName}</p>
                    <p class="text-sm text-slate-500 dark:text-slate-500">Utente: ${item.user}</p>
                    <div class="flex gap-2 mt-3">
                        <button data-validation-id="${item.id}" class="approve-validation-btn flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">Approva</button>
                        <button data-validation-id="${item.id}" class="reject-validation-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">Rifiuta</button>
                    </div>
                </div>`);
        }

        // Renderizza la lista degli obiettivi durante la creazione/modifica missione
        function renderNewMissionObjectives() {
            const buffer = state.editingMissionBuffer || state.newMissionBuffer;
            renderList('new-mission-objectives-list', buffer?.objectives || [], (obj, index) => `
                <div class="p-2 bg-slate-100 dark:bg-slate-700/50 rounded-lg flex justify-between items-center text-sm">
                    <span>${obj.text}</span>
                    <button type="button" data-objective-index="${index}" class="remove-objective-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`);
        }

        // Funzione per entrare in modalità simulazione
        function simulateUserView(role) {
            if (!state.simulatedProfileStates[role]) return;
            if (state.isSimulating && state.currentSimulatedRole) {
                const prevSimState = state.simulatedProfileStates[state.currentSimulatedRole];
                if (prevSimState) {
                    prevSimState.activeMission = state.activeMission;
                    prevSimState.currentScore = state.currentScore;
                    prevSimState.hourglasses = state.hourglasses;
                }
            } else if (!state.isSimulating) {
                state.masterStateCache = {
                    activeMission: state.activeMission,
                    currentScore: state.currentScore,
                    hourglasses: state.hourglasses
                };
            }
            state.isSimulating = true;
            state.currentSimulatedRole = role;
            const simState = state.simulatedProfileStates[role];
            state.activeMission = simState.activeMission;
            state.currentScore = simState.currentScore;
            state.hourglasses = simState.hourglasses;
            updateProgressBar();
            document.getElementById('hourglassCount').textContent = state.hourglasses;
            const mockProfile = {
                name: `Utente ${role}`,
                email: `simulazione@${role.toLowerCase()}.test`,
                role: role,
                totalDonations: simState.totalDonations 
            };
            state.currentUserProfile = mockProfile;
            updateProfileView(mockProfile); 
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('exit-simulation-btn').classList.remove('hidden');
            document.getElementById('simulation-notice').classList.remove('hidden');
            showView('profile');
        }

        // Funzione per uscire dalla modalità simulazione
        function exitSimulation() {
            if (state.currentSimulatedRole) {
                const simState = state.simulatedProfileStates[state.currentSimulatedRole];
                simState.activeMission = state.activeMission;
                simState.currentScore = state.currentScore;
                simState.hourglasses = state.hourglasses;
            }
            if (state.masterStateCache) {
                state.activeMission = state.masterStateCache.activeMission;
                state.currentScore = state.masterStateCache.currentScore;
                state.hourglasses = state.masterStateCache.hourglasses;
            } else { 
                state.activeMission = null;
                state.currentScore = 0;
                state.hourglasses = 0;
            }
            state.masterStateCache = null;
            state.currentSimulatedRole = null;
            state.currentUserProfile = null; 
            state.isSimulating = false;
            updateProgressBar();
            document.getElementById('hourglassCount').textContent = state.hourglasses;
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('exit-simulation-btn').classList.add('hidden');
            document.getElementById('simulation-notice').classList.add('hidden');
            showView('master-dashboard');
        }


        // ===================================================================================
        // 5. GESTORI EVENTI FORM E AZIONI UTENTE
        // ===================================================================================
        
        // RIMOSSI: handleRegistration e handleLogin (basati su Firebase Auth)
        
        // ===================================================================================
        // NUOVA FUNZIONE: Conferma Registrazione (basata su Telegram)
        // ===================================================================================
        function handleConfirmRegistration() {
            toggleLoader(true);
            const role = state.registrationRole;
            const user = tg.initDataUnsafe.user;
            
            if (!user || !role) {
                showNotification("Errore: Dati utente o ruolo mancanti.", "error");
                toggleLoader(false);
                return;
            }

            const profile = {
                id: user.id,
                name: `${user.first_name} ${user.last_name || ''}`.trim(),
                email: user.username ? `@${user.username}` : `tg-id-${user.id}`, // Usa username o ID
                role: role,
                totalDonations: 0,
                createdAt: new Date().toISOString()
            };

            // Salva il profilo nel Cloud Storage di Telegram
            tg.CloudStorage.setItem('user_profile', JSON.stringify(profile), (err, success) => {
                toggleLoader(false);
                if (success) {
                    state.currentUserProfile = profile;
                    updateProfileView();
                    showView('profile');
                    showNotification('Profilo creato con successo!', 'success');
                } else {
                    showNotification(`Errore nel salvataggio del profilo: ${err}`, 'error');
                }
            });
        }


        // Gestisce il primo step della creazione/modifica missione (invariato)
        function handleCreateOrUpdateMissionStep1(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements['mission-name'].value.trim();
            const description = form.elements['mission-description'].value.trim();
            const lat = form.elements['mission-lat'].value;
            const lon = form.elements['mission-lon'].value;
            const street = form.elements['mission-street'].value.trim();
            const city = form.elements['mission-city'].value.trim();
            const country = form.elements['mission-country'].value.trim();
            const maxUsers = parseInt(form.elements['mission-max-users'].value) || 1;

            if(!name || !description || ((!lat || !lon) && (!street || !city))) {
                showFormError('mission-step1', 'Compila nome, descrizione e un indirizzo o coordinate.');
                return;
            }
            document.getElementById('mission-step1-error').classList.add('hidden');

            const missionData = {
                name, description,
                color: form.elements['mission-color'].value,
                lat: parseFloat(lat) || null, lon: parseFloat(lon) || null,
                street, city, country, status: 'available',
                maxUsers: maxUsers, 
                participants: state.editingMissionBuffer?.participants || [], 
                objectives: state.editingMissionBuffer?.objectives || []
            };

            if (state.editingMissionBuffer) state.editingMissionBuffer = {...state.editingMissionBuffer, ...missionData };
            else state.newMissionBuffer = missionData;

            document.getElementById('new-mission-title').textContent = name;
            renderNewMissionObjectives();
            showView('create-mission-step2');
        }

        // Aggiunge un obiettivo during la creazione/modifica missione (invariato)
        function handleAddObjective(e) {
            e.preventDefault();
            const buffer = state.editingMissionBuffer || state.newMissionBuffer;
            const input = document.getElementById('objective-text');
            const text = input.value.trim();
            if (text && buffer) {
                buffer.objectives.push({ id: Date.now(), text: text, progress: 0, target: 10, points: 5 }); // Target e punti di default
                renderNewMissionObjectives();
                input.value = '';
            }
        }

        // Aggiunge un obiettivo comune (dal Master Dashboard) (invariato)
        function handleAddCommonObjective(e) {
            e.preventDefault();
            const form = e.target;
            const textInput = form.elements['common-objective-text'];
            const targetInput = form.elements['common-objective-target'];
            const text = textInput.value.trim();
            const target = parseInt(targetInput.value);

            if (text && target > 0) {
                MOCK_DATA.commonObjectives.push({ id: Date.now(), text: text, progress: 0, target: target });
                renderManageCommonObjectives();
                form.reset();
            }
        }

        // Salva la missione creata/modificata (invariato)
        function handleSaveMission() {
            let missionName = '';
            if (state.editingMissionBuffer) {
                const index = MOCK_DATA.missions.findIndex(m => m.name === state.editingMissionBuffer.originalName);
                if (index !== -1) {
                    missionName = state.editingMissionBuffer.name;
                    MOCK_DATA.missions[index] = { ...state.editingMissionBuffer }; 
                    delete MOCK_DATA.missions[index].originalName; 
                }
                state.editingMissionBuffer = null;
                showNotification(`Missione "${missionName}" aggiornata!`);
            } else if (state.newMissionBuffer) {
                missionName = state.newMissionBuffer.name;
                MOCK_DATA.missions.push(state.newMissionBuffer);
                state.newMissionBuffer = null;
                showNotification(`Nuova missione "${missionName}" creata!`);
            }

            renderMissionList();
            document.getElementById('createMissionFormStep1').reset(); 

            // Torna alla vista corretta (logica invariata)
            const returnView = (state.currentUserProfile && state.currentUserProfile.role === 'Sostenitore') ? 'profile' : 'manage-missions';
            showView(returnView);
        }

        // Gestisce la donazione simulata (invariato)
        function handleDonation(e) {
            e.preventDefault();
            const amountInput = document.getElementById('donation-amount');
            const amount = parseFloat(amountInput.value);

            if (amount > 0) {
                toggleLoader(true);
                MOCK_DATA.globalDonationTotal += amount;
                document.getElementById('donatedCredit').textContent = MOCK_DATA.globalDonationTotal.toLocaleString('it-IT') + ' €';

                let profileToUpdate = null;
                if (state.isSimulating && state.currentSimulatedRole) {
                    profileToUpdate = state.simulatedProfileStates[state.currentSimulatedRole];
                } else if (state.currentUserProfile) {
                    profileToUpdate = state.currentUserProfile;
                }
                if (profileToUpdate) {
                    profileToUpdate.totalDonations = (profileToUpdate.totalDonations || 0) + amount;
                }

                setTimeout(() => {
                    toggleLoader(false);
                    showNotification(`Grazie per la tua donazione di ${amount.toLocaleString('it-IT')} €!`, 'success');
                    amountInput.value = '';
                    if (document.getElementById('profile').classList.contains('active')) {
                         updateProfileView(state.currentUserProfile);
                    }
                    if (state.currentUserProfile) { // Torna al profilo (reale o simulato)
                       showView('profile');
                    }
                }, 1000);
            } else {
                showNotification('Inserisci un importo valido.', 'error');
            }
        }

        // ===================================================================================
        // MODIFICATO: handleLogout ora chiude la Mini App
        // ===================================================================================
        function handleLogout() {
            stopMissionTimer();
            // Chiude la finestra della Mini App
            tg.close();
        }

        // ===================================================================================
        // 6. INIZIALIZZAZIONE DELL'APP ED EVENT LISTENER GLOBALE
        // ===================================================================================

        async function startApp() {
            // 1. Inizializza Telegram Web App
            tg.ready();
            applyTheme(); // Applica il tema all'avvio
            tg.expand(); // Espandi l'app a schermo intero
            
            // 2. Imposta listener per cambio tema
            tg.onEvent('themeChanged', applyTheme);
            
            // 3. Imposta listener per BackButton nativo
            tg.BackButton.onClick(() => {
                viewHistory.pop(); // Rimuovi la vista corrente
                const prevViewId = viewHistory[viewHistory.length - 1]; // Prendi la vista precedente
                if (prevViewId) {
                    showView(prevViewId, true); // Mostra la vista precedente (marcandola come 'back')
                }
            });
            
            // Imposta totale donazioni globale iniziale
            document.getElementById('donatedCredit').textContent = MOCK_DATA.globalDonationTotal.toLocaleString('it-IT') + ' €';

            // 4. Ottieni dati utente Telegram
            const user = tg.initDataUnsafe.user;

            // Se non siamo in Telegram, mostra errore
            if (!user) {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('telegram-error').style.display = 'block';
                lucide.createIcons();
                return;
            }

            // ===================================================================================
            // MODIFICATO: Event Listener Globale
            // ===================================================================================
            document.getElementById('app-container').addEventListener('click', (e) => {
                const target = e.target;
                const viewButton = target.closest('[data-view]');
                const viewOnMapButton = target.closest('.view-on-map-btn');
                const progressButton = target.closest('[data-progress-points]');
                const simulateButton = target.closest('[data-simulate-role]');
                const acceptMissionButton = target.closest('.accept-mission-btn');
                const removeObjectiveBtn = target.closest('.remove-objective-btn');
                const toggleDetailsButton = target.closest('.toggle-details-btn');
                const toggleParticipantsButton = target.closest('.toggle-participants-btn');
                const editMissionBtn = target.closest('.edit-mission-btn');
                const interruptMissionBtn = target.closest('#interrupt-mission-btn');
                const advanceCommonObjectiveBtn = target.closest('.advance-common-objective-btn');
                const removeCommonObjectiveBtn = target.closest('.remove-common-objective-btn');
                const requestValidationBtn = target.closest('.request-validation-btn');
                const approveValidationBtn = target.closest('.approve-validation-btn');
                const rejectValidationBtn = target.closest('.reject-validation-btn');
                const dismissResultBtn = target.closest('.dismiss-result-btn');

                // --- GESTIONE CAMBIO VISTA ---
                if (viewButton) {
                    const viewId = viewButton.dataset.view;
                    if(viewId === 'master-dashboard' || viewId === 'profile') {
                        state.editingMissionBuffer = null; state.newMissionBuffer = null; // Pulisce buffer
                    }
                    if(viewId === 'create-mission-step1' && !state.editingMissionBuffer) { // Reset form creazione
                        document.getElementById('mission-form-title-step1').textContent = "Crea Missione (Step 1/2)";
                        document.getElementById('mission-step1-submit-btn').textContent = "Avanti: Aggiungi Obiettivi";
                        document.getElementById('createMissionFormStep1').reset();
                        document.getElementById('mission-max-users').value = 1;
                    }
                    if (viewId === 'missione-accettata') { // Popola vista missione accettata
                        const mission = MOCK_DATA.missions.find(m => m.name === viewButton.dataset.missionName);
                        if (mission) populateAcceptedMissionView(mission);
                    }
                    if (viewButton.dataset.role) { // Gestione selezione ruolo registrazione
                        const role = viewButton.dataset.role;
                        if (viewId === 'register-form') {
                            state.registrationRole = role;
                            // La popolazione della vista ora avviene in showView
                        }
                    }
                    showView(viewId); // Mostra la vista richiesta
                }

                // --- GESTIONI SPECIFICHE DEI PULSANTI (Logica invariata) ---

                if (toggleDetailsButton) {
                    const missionName = toggleDetailsButton.dataset.missionName;
                    const detailsPanel = document.getElementById(`details-${missionName.replace(/\s+/g, '-')}`);
                    if (detailsPanel) {
                        document.querySelectorAll('.mission-details.open').forEach(openPanel => {
                             if (openPanel !== detailsPanel) openPanel.classList.remove('open');
                        });
                        detailsPanel.classList.toggle('open');
                    }
                }
                
                if (toggleParticipantsButton) { 
                    const missionName = toggleParticipantsButton.dataset.missionName;
                    const participantsPanel = document.getElementById(`participants-${missionName.replace(/\s+/g, '-')}`);
                    if (participantsPanel) {
                        document.querySelectorAll('.mission-details.open').forEach(openPanel => {
                             if (openPanel !== participantsPanel) openPanel.classList.remove('open');
                        });
                        participantsPanel.classList.toggle('open');
                    }
                }

                if (editMissionBtn) {
                    const missionToEdit = MOCK_DATA.missions.find(m => m.name === editMissionBtn.dataset.missionName);
                    if (missionToEdit) {
                        state.editingMissionBuffer = JSON.parse(JSON.stringify(missionToEdit)); 
                        state.editingMissionBuffer.originalName = missionToEdit.name;
                        document.getElementById('mission-form-title-step1').textContent = "Modifica Missione (Step 1/2)";
                        document.getElementById('mission-step1-submit-btn').textContent = "Salva e Vai a Obiettivi";
                        const form = document.getElementById('createMissionFormStep1');
                        form.elements['mission-name'].value = missionToEdit.name;
                        form.elements['mission-description'].value = missionToEdit.description;
                        form.elements['mission-lat'].value = missionToEdit.lat || '';
                        form.elements['mission-lon'].value = missionToEdit.lon || '';
                        form.elements['mission-street'].value = missionToEdit.street || '';
                        form.elements['mission-city'].value = missionToEdit.city || '';
                        form.elements['mission-country'].value = missionToEdit.country || '';
                        form.elements['mission-color'].value = missionToEdit.color || 'indigo';
                        form.elements['mission-max-users'].value = missionToEdit.maxUsers || 1;
                        showView('create-mission-step1');
                    }
                }
                
                if (interruptMissionBtn && state.activeMission) { 
                    const missionInMock = MOCK_DATA.missions.find(m => m.name === state.activeMission.name);
                    if (missionInMock && state.currentUserProfile) {
                        missionInMock.participants = missionInMock.participants.filter(name => name !== state.currentUserProfile.name);
                    }
                    showNotification(`Missione "${state.activeMission.name}" interrotta.`, 'info');
                    state.activeMission = null; 
                    stopMissionTimer(); 
                    renderMissionList(); 
                    showView('pianifica');
                }
                
                if (viewOnMapButton) {
                    const mission = MOCK_DATA.missions.find(m => m.name === viewOnMapButton.dataset.missionName);
                    if (mission) updateMapLocation(mission);
                }
                
                if (acceptMissionButton && !state.activeMission) { 
                    const mission = MOCK_DATA.missions.find(m => m.name === acceptMissionButton.dataset.missionName);
                    if (mission && mission.participants.length < mission.maxUsers) {
                        if (state.currentUserProfile) {
                            mission.participants.push(state.currentUserProfile.name);
                        } else {
                            mission.participants.push('Utente Sconosciuto'); 
                        }
                        state.activeMission = JSON.parse(JSON.stringify(mission)); 
                        state.activeMission.missionStartTime = Date.now();
                        state.activeMission.initialRewardClaimed = false;
                        renderMissionList(); 
                        startMissionTimer();
                        showNotification(`Missione "${mission.name}" accettata!`);
                    } else if (mission) {
                        showNotification(`La missione "${mission.name}" è al completo.`, 'error');
                    }
                }
                
                if (removeObjectiveBtn) { 
                    const buffer = state.editingMissionBuffer || state.newMissionBuffer;
                    if (buffer) {
                        buffer.objectives.splice(parseInt(removeObjectiveBtn.dataset.objectiveIndex), 1);
                        renderNewMissionObjectives();
                    }
                }

                if (requestValidationBtn && state.activeMission && state.currentUserProfile) { 
                    const userName = state.currentUserProfile.name;
                    MOCK_DATA.validationQueue.push({
                        id: Date.now(), missionName: state.activeMission.name,
                        objectiveText: requestValidationBtn.dataset.objectiveText, user: userName
                    });
                    requestValidationBtn.textContent = 'In attesa...'; requestValidationBtn.disabled = true;
                    requestValidationBtn.classList.replace('bg-blue-500', 'bg-slate-400');
                     requestValidationBtn.classList.remove('hover:bg-blue-600');
                    showNotification('Richiesta inviata!', 'info');
                }

                if (approveValidationBtn) { 
                    const validationId = parseInt(approveValidationBtn.dataset.validationId);
                    const requestIndex = MOCK_DATA.validationQueue.findIndex(req => req.id === validationId);
                    if (requestIndex > -1) {
                         const request = MOCK_DATA.validationQueue.splice(requestIndex, 1)[0];
                         let profileStateToUpdate = null; 
                         if (request.user.startsWith('Utente ')) { 
                             const role = request.user.split(' ')[1];
                             profileStateToUpdate = state.simulatedProfileStates[role];
                         } 
                         if (profileStateToUpdate && profileStateToUpdate.activeMission?.name === request.missionName) {
                             const objective = profileStateToUpdate.activeMission.objectives.find(o => o.text === request.objectiveText && o.progress < o.target);
                             if (objective) { 
                                objective.progress += 1; 
                                const pointsToAdd = (objective.points / objective.target); 
                                profileStateToUpdate.currentScore += pointsToAdd; 
                                if (profileStateToUpdate.currentScore >= 60) { 
                                    profileStateToUpdate.hourglasses += Math.floor(profileStateToUpdate.currentScore / 60);
                                    profileStateToUpdate.currentScore %= 60;
                                }
                                MOCK_DATA.validationResults.push({
                                    id: Date.now(),
                                    user: request.user,
                                    objectiveText: request.objectiveText,
                                    status: 'approved',
                                    points: pointsToAdd
                                });
                             }
                         }
                         renderValidationQueue();
                         showNotification(`Validazione per ${request.user} approvata!`, 'success');
                    }
                }

                if (rejectValidationBtn) {
                     const validationId = parseInt(rejectValidationBtn.dataset.validationId);
                     const requestIndex = MOCK_DATA.validationQueue.findIndex(req => req.id === validationId);
                    if (requestIndex > -1) {
                         const request = MOCK_DATA.validationQueue.splice(requestIndex, 1)[0];
                         if(state.isSimulating && state.currentSimulatedRole === 'Collaboratore' && document.getElementById('missione-in-corso').classList.contains('active')) {
                             const objectiveButton = document.querySelector(`.request-validation-btn[data-objective-text="${request.objectiveText}"]`);
                             if(objectiveButton) {
                                 objectiveButton.textContent = 'Richiedi Validazione';
                                 objectiveButton.disabled = false;
                                 objectiveButton.classList.replace('bg-slate-400', 'bg-blue-500');
                                  objectiveButton.classList.add('hover:bg-blue-600');
                             }
                         }
                         MOCK_DATA.validationResults.push({
                            id: Date.now(),
                            user: request.user,
                            objectiveText: request.objectiveText,
                            status: 'rejected',
                            points: 0
                         });
                         renderValidationQueue();
                         showNotification('Validazione rifiutata.', 'info');
                    }
                }
                
                if (dismissResultBtn) {
                    const resultId = parseInt(dismissResultBtn.dataset.resultId);
                    const index = MOCK_DATA.validationResults.findIndex(r => r.id === resultId);
                    if (index > -1) {
                        MOCK_DATA.validationResults.splice(index, 1);
                        renderValidationResults();
                    }
                }

                if (advanceCommonObjectiveBtn) { 
                    const objective = MOCK_DATA.commonObjectives.find(o => o.id === parseInt(advanceCommonObjectiveBtn.dataset.commonObjectiveId));
                    if (objective && objective.progress < objective.target) { objective.progress += 1; renderCommonObjectives(); }
                }

                if (removeCommonObjectiveBtn) { 
                    const index = MOCK_DATA.commonObjectives.findIndex(o => o.id === parseInt(removeCommonObjectiveBtn.dataset.commonObjectiveId));
                    if (index > -1) { MOCK_DATA.commonObjectives.splice(index, 1); renderManageCommonObjectives(); }
                }

                if (progressButton) { 
                    updateProgress(parseInt(progressButton.dataset.progressPoints));
                }

                if (simulateButton) { 
                    simulateUserView(simulateButton.dataset.simulateRole);
                }
            });

            // Associa i gestori principali ai form e pulsanti globali
            // RIMOSSO: registrationForm e loginForm (submit)
            // AGGIUNTO:
            document.getElementById('confirm-registration-btn').addEventListener('click', handleConfirmRegistration);
            
            // (Invariati)
            document.getElementById('createMissionFormStep1').addEventListener('submit', handleCreateOrUpdateMissionStep1);
            document.getElementById('addObjectiveForm').addEventListener('submit', handleAddObjective);
            document.getElementById('addCommonObjectiveForm').addEventListener('submit', handleAddCommonObjective);
            document.getElementById('donationForm').addEventListener('submit', handleDonation);
            document.getElementById('save-mission-btn').addEventListener('click', handleSaveMission);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('master-logout-btn').addEventListener('click', handleLogout); 
            document.getElementById('exit-simulation-btn').addEventListener('click', exitSimulation);

            // Renderizza le liste iniziali
            renderList('nft-list', MOCK_DATA.nfts, nft => `<button data-nft-id="${nft.id}" class="w-full text-left p-3 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center gap-4"><div class="w-10 h-10 ${nft.color} rounded-lg flex-shrink-0"></div><div><p class="font-semibold">${nft.name}</p><p class="text-xs text-slate-500">${nft.tokenId}</p></div></button>`);
            renderList('donations-list-container', MOCK_DATA.donations, d => `<div class="p-4 bg-slate-100 dark:bg-slate-700/50 rounded-xl flex items-center gap-4"><i data-lucide="${d.icon}" class="w-8 h-8 text-indigo-500 flex-shrink-0"></i><div><p class="font-bold">${d.name} <span class="text-sm font-normal text-slate-500">(x${d.quantity})</span></p><p class="text-sm text-slate-600 dark:text-slate-400">${d.description}</p></div></div>`);
            renderActivityLog();

            // ===================================================================================
            // 5. NUOVO FLUSSO DI AVVIO (basato su CloudStorage)
            // ===================================================================================
            
            // Resetta stato UI
            state.currentUserProfile = null;
            state.activeMission = null; state.currentScore = 0; state.hourglasses = 0;
            updateProgressBar(); document.getElementById('hourglassCount').textContent = '0';
            
            // Controlla se è l'utente Master
            if (user.id === MASTER_ADMIN_ID) {
                console.log("Accesso Master Riconosciuto.");
                // Nascondi il loader e mostra la dashboard
                toggleLoader(false);
                showView('master-dashboard');
                return; // Termina il flusso di avvio
            }

            // Per utenti normali, controlla il Cloud Storage
            toggleLoader(true);
            tg.CloudStorage.getItem('user_profile', (err, value) => {
                toggleLoader(false);
                if (err) {
                    showNotification(`Errore nel recupero dati: ${err}`, 'error');
                    showView('register-choice'); // Mostra registrazione come fallback
                    return;
                }

                if (value) {
                    // UTENTE ESISTENTE: Carica il profilo
                    console.log("Profilo trovato nel Cloud Storage.");
                    state.currentUserProfile = JSON.parse(value);
                    
                    // Controlla se l'utente ha una missione attiva (logica mock)
                    const activeMissionFromMock = MOCK_DATA.missions.find(m => m.participants.includes(state.currentUserProfile.name));
                    if (activeMissionFromMock) {
                        state.activeMission = JSON.parse(JSON.stringify(activeMissionFromMock));
                    }

                    updateProfileView();
                    showView('profile');
                } else {
                    // NUOVO UTENTE: Mostra la schermata di scelta ruolo
                    console.log("Nessun profilo trovato. Avvio registrazione.");
                    showView('register-choice');
                }
            });
        }

        // Avvia l'app quando il DOM è pronto
        document.addEventListener('DOMContentLoaded', startApp);

    </script>
</body>
</html>